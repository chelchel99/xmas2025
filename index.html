<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Christmas - AI Art</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #050505; color: #d4af37; font-family: 'Cinzel', serif; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 30px; height: 30px; border: 2px solid rgba(212,175,55,0.2); border-top: 2px solid #d4af37; border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }
        .ui { position: fixed; top: 10%; width: 100%; text-align: center; pointer-events: none; z-index: 10; }
        h1 { font-size: 3rem; margin: 0; background: linear-gradient(180deg, #fff, #d4af37); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(212,175,55,0.4)); }
        p { font-size: 0.8rem; letter-spacing: 3px; margin-top: 10px; opacity: 0.6; }
        /* 隱藏攝影機 */
        #v { position: fixed; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><p>Summoning Magic...</p ></div>
    <div class="ui">
        <h1>Merry Christmas</h1>
        <p>Gently move your hand to spin the stars</p >
    </div>
    <video id="v" autoplay playsinline></video>

    <script type="importmap">
    { "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
        "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
    }}
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        let s, c, r, g, hl, comp, ps = [], st = { m: 'TREE', rx: 0, ry: 0 };

        async function init() {
            s = new THREE.Scene();
            c = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
            c.position.z = 60;
            
            r = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            r.setSize(window.innerWidth, window.innerHeight);
            r.toneMapping = THREE.ReinhardToneMapping;
            document.body.appendChild(r.domElement);

            g = new THREE.Group(); s.add(g);
            s.add(new THREE.AmbientLight(0xffffff, 0.4));
            const pl = new THREE.PointLight(0xd4af37, 500); pl.position.set(0, 0, 50); s.add(pl);

            // 高雅的輝光特效
            comp = new EffectComposer(r);
            comp.addPass(new RenderPass(s, c));
            comp.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.8, 0.3, 0.85));

            // 建立金星粒子
            const starShape = new THREE.Shape();
            for(let i=0; i<5; i++) {
                const angle = (i/5) * Math.PI * 2;
                const nextAngle = ((i+0.5)/5) * Math.PI * 2;
                if(i===0) starShape.moveTo(Math.cos(angle), Math.sin(angle));
                starShape.lineTo(Math.cos(angle), Math.sin(angle));
                starShape.lineTo(Math.cos(nextAngle)*0.4, Math.sin(nextAngle)*0.4);
            }
            const starGeo = new THREE.ExtrudeGeometry(starShape, { depth: 0.2, bevelEnabled: false });
            const starMat = new THREE.MeshStandardMaterial({ color: 0xd4af37, metalness: 0.9, roughness: 0.2 });

            for(let i=0; i<800; i++) {
                const m = new THREE.Mesh(starGeo, starMat);
                m.scale.setScalar(0.3 + Math.random()*0.3);
                ps.push({ 
                    m, 
                    t: new THREE.Vector3(), 
                    s: new THREE.Vector3().randomDirection().multiplyScalar(20 + Math.random()*20),
                    rs: new THREE.Vector3().randomDirection().multiplyScalar(0.05)
                });
                g.add(m);
            }

            // 背景雪花粒子
            const snowGeo = new THREE.BufferGeometry();
            const snowPos = [];
            for(let i=0; i<2000; i++) snowPos.push(Math.random()*200-100, Math.random()*200-100, Math.random()*100-50);
            snowGeo.setAttribute('position', new THREE.Float32BufferAttribute(snowPos, 3));
            const snowMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0.5 });
            s.add(new THREE.Points(snowGeo, snowMat));

            await setup();
            loop();
        }

        async function setup() {
            const res = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            hl = await HandLandmarker.createFromOptions(res, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task", delegate: "GPU" },
                runningMode: "VIDEO", numHands: 1
            });
            const video = document.getElementById('v');
            try {
                video.srcObject = await navigator.mediaDevices.getUserMedia({ video: true });
                video.onloadeddata = () => { document.getElementById('loader').style.opacity = '0'; setTimeout(()=>document.getElementById('loader').remove(), 1000); };
            } catch(e) { 
                document.getElementById('loader').innerHTML = "Camera Required"; 
            }
        }

        function loop() {
            requestAnimationFrame(loop);
            const video = document.getElementById('v');
            if (hl && video.readyState === 4) {
                const res = hl.detectForVideo(video, performance.now());
                if (res.landmarks?.[0]) {
                    const l = res.landmarks[0];
                    st.ry = (l[9].x - 0.5) * 4; st.rx = (l[9].y - 0.5) * 3;
                    st.m = Math.hypot(l[8].x - l[0].x, l[8].y - l[0].y) < 0.25 ? 'TREE' : 'SCATTER';
                }
            }
            g.rotation.y = THREE.MathUtils.lerp(g.rotation.y, st.ry, 0.05);
            g.rotation.x = THREE.MathUtils.lerp(g.rotation.x, st.rx, 0.05);
            
            ps.forEach((p, i) => {
                if (st.m === 'TREE') {
                    const t = i / ps.length;
                    const r = 14 * (1-t);
                    const a = t * 60;
                    p.t.set(Math.cos(a)*r, t*35-18, Math.sin(a)*r);
                } else p.t.copy(p.s);
                p.m.position.lerp(p.t, 0.05);
                p.m.rotation.x += p.rs.x; p.m.rotation.y += p.rs.y;
            });
            comp.render();
        }
        init();
        window.onresize = () => {
            c.aspect = window.innerWidth / window.innerHeight; c.updateProjectionMatrix();
            r.setSize(window.innerWidth, window.innerHeight); comp.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
