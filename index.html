<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xmas AI - Fast Load</title>
    <style>
        body { margin: 0; background: #000; color: #d4af37; font-family: sans-serif; overflow: hidden; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 30px; height: 30px; border: 2px solid rgba(212,175,55,0.2); border-top: 2px solid #d4af37; border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }
        .ui { position: fixed; top: 20px; width: 100%; text-align: center; pointer-events: none; z-index: 10; }
        h1 { font-size: 2rem; margin: 0; text-shadow: 0 0 10px #d4af37; }
        video { position: fixed; bottom: 10px; right: 10px; width: 80px; height: 60px; opacity: 0.2; transform: scaleX(-1); border-radius: 4px; }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><p>魔法載入中...</p ></div>
    <div class="ui"><h1>Merry Christmas</h1></div>
    <video id="v" autoplay playsinline></video>

    <script type="importmap">
    { "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
    }}
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        let s, c, r, g, hl, ps = [], st = { m: 'TREE', rx: 0, ry: 0 };

        async function init() {
            s = new THREE.Scene();
            c = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
            c.position.z = 50;
            r = new THREE.WebGLRenderer({ antialias: false }); // 關閉抗鋸齒以提升速度
            r.setSize(window.innerWidth, window.innerHeight);
            r.setPixelRatio(1); // 限制像素比提升效能
            document.body.appendChild(r.domElement);
            g = new THREE.Group(); s.add(g);
            s.add(new THREE.AmbientLight(0xffffff, 1));

            const geo = new THREE.SphereGeometry(0.3, 6, 6);
            const mat = new THREE.MeshBasicMaterial({ color: 0xd4af37 });
            for(let i=0; i<600; i++) { // 減少粒子數量
                const m = new THREE.Mesh(geo, mat);
                ps.push({ m, t: new THREE.Vector3(), s: new THREE.Vector3().randomDirection().multiplyScalar(25) });
                g.add(m);
            }
            await setup();
            loop();
        }

        async function setup() {
            const res = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            hl = await HandLandmarker.createFromOptions(res, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task", delegate: "GPU" },
                runningMode: "VIDEO", numHands: 1
            });
            const video = document.getElementById('v');
            video.srcObject = await navigator.mediaDevices.getUserMedia({ video: true });
            video.onloadeddata = () => { document.getElementById('loader').remove(); };
        }

        function loop() {
            requestAnimationFrame(loop);
            const video = document.getElementById('v');
            if (hl && video.readyState === 4) {
                const res = hl.detectForVideo(video, performance.now());
                if (res.landmarks?.[0]) {
                    const l = res.landmarks[0];
                    st.ry = (l[9].x - 0.5) * 3; st.rx = (l[9].y - 0.5) * 2;
                    st.m = Math.hypot(l[8].x - l[0].x, l[8].y - l[0].y) < 0.2 ? 'TREE' : 'SCATTER';
                }
            }
            g.rotation.y = THREE.MathUtils.lerp(g.rotation.y, st.ry, 0.1);
            g.rotation.x = THREE.MathUtils.lerp(g.rotation.x, st.rx, 0.1);
            ps.forEach((p, i) => {
                if (st.m === 'TREE') {
                    const t = i / ps.length;
                    p.t.set(Math.cos(t*40)*12*(1-t), t*30-15, Math.sin(t*40)*12*(1-t));
                } else p.t.copy(p.s);
                p.m.position.lerp(p.t, 0.1);
            });
            r.render(s, c);
        }
        init();
    </script>
</body>
</html>
